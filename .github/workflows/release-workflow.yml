# SPDX-FileCopyrightText: 2025 diggsweden/eudiw-wallet-token-lib
#
# SPDX-License-Identifier: CC0-1.0

# Release Workflow
# 
# Purpose: Automated release process for Maven libraries published to Maven Central.
# Authorization is automatically enforced via AUTHORIZED_RELEASE_DEVELOPERS secret:
# - SNAPSHOT releases: Anyone with tag push access can release
# - Production releases: Only authorized developers can release
#
# Required Secrets:
#   AUTHORIZED_RELEASE_DEVELOPERS: Comma-separated list of authorized GitHub usernames
#   MAVENCENTRAL_USERNAME: Maven Central OSSRH username
#   MAVENCENTRAL_PASSWORD: Maven Central OSSRH password
#   OSPO_BOT_GPG_PRIV: GPG private key for artifact signing
#   OSPO_BOT_GPG_PASS: GPG key passphrase
#   OSPO_BOT_GPG_PUB: GPG public key
#   RELEASE_TOKEN: GitHub token for creating releases
#
name: Release Workflow

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"              # Stable: v1.0.0
      - "v[0-9]+.[0-9]+.[0-9]+-SNAPSHOT*"    # Snapshot: v1.0.0-SNAPSHOT

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false  # Queue releases, don't cancel partial releases

permissions:
  contents: read  # Best Security practice. Jobs only get read as base, and then permissions are added as needed

jobs:
  release:
    uses: diggsweden/reusable-ci/.github/workflows/release-orchestrator.yml@v1
    permissions:
      contents: write         # Create GitHub releases and tags
      packages: write         # Publish to GitHub Packages (backup)
      id-token: write        # Generate OIDC token for Maven Central
      actions: read          # Needed by SLSA provenance
      attestations: write    # Needed by SBOM attestation
      security-events: write # Needed by container scan (N/A for libs)
    secrets: inherit  # Use org-level MAVEN_CENTRAL credentials, GPG keys, and AUTHORIZED_RELEASE_DEVELOPERS
    with:
      # Project configuration
      projectType: maven  # Build system type (determines version file location)
      
      # Publishers and tools
      artifactPublisher: maven-lib-mavencentral       # Publish library to Maven Central (auto-enables authorization)
      artifact.jreleaserenabled: true                 # JReleaser plugin configured in pom.xml
      artifact.settingspath: ".mvn/settings.xml"      # Contains Maven Central server config
      
      changelogCreator: git-cliff  # Generate changelog from conventional commits